version: '3.8'

services:
  # =============================================================================
  # Microsoft 365 MCP Server
  # =============================================================================
  m365-mcp-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: m365-mcp-server
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Azure AD / Entra ID (required)
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}

      # Server configuration
      - PORT=3000
      - MCP_SERVER_BASE_URL=${MCP_SERVER_BASE_URL:-http://localhost:3000}
      - SESSION_SECRET=${SESSION_SECRET}
      - NODE_ENV=${NODE_ENV:-production}

      # Redis for distributed sessions (optional)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - mcp-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health',(r)=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # Redis for session storage (optional but recommended for production)
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: m365-mcp-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # Open WebUI (optional - for testing/demo)
  # =============================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-your-secret-key-here}
      - WEBUI_NAME=M365 MCP Demo
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - mcp-network
    profiles:
      - with-webui

  # =============================================================================
  # MCPO Proxy (optional - for OpenAPI compatibility)
  # =============================================================================
  mcpo:
    image: ghcr.io/open-webui/mcpo:latest
    container_name: mcpo
    restart: unless-stopped
    ports:
      - "8000:8000"
    command: ["--config", "/config/mcp-config.json", "--port", "8000"]
    volumes:
      - ./mcpo-config.json:/config/mcp-config.json:ro
    networks:
      - mcp-network
    profiles:
      - with-mcpo

networks:
  mcp-network:
    driver: bridge

volumes:
  redis-data:
  open-webui-data:
